'use strict';

var games = [{
    'id': 14249,
    'name': "'Allo 'Allo! Cartoon Fun!",
    'summary': null,
    'genres': ['Platform'],
    'platforms': [{'name': 'Amiga', 'releaseDate': '1993-12-30'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '1993-12-30',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 19055,
    'name': "'n Verlore Verstand",
    'summary': 'Be prepared to be transported to a reality of dreams and nightmares. What will you discover about yourself in this journey through the subconscious?',
    'genres': [],
    'platforms': [],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': null,
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 12693,
    'name': "'Nam 1965 - 1975",
    'summary': null,
    'genres': ['Strategy'],
    'platforms': [{'name': 'Amiga', 'releaseDate': '1991-12-30'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '1991-12-30',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 9888,
    'name': '#IDARB',
    'summary': 'Prepare to battle everything from Moustache Cops to Breakfast, in this game inspired by fast action, 8-bit sports and arcade classics! Built with the input of thousands of crazed internet gamers, #IDA',
    'genres': ['Platform', 'Sport', 'Indie'],
    'platforms': [{'name': 'Xbox One', 'releaseDate': '2015-01-29'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2015-01-29',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/whgrfj9muktnnpags6qg.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 26369,
    'name': '#KILLALLZOMBIES',
    'summary': '#KILLALLZOMBIES is an insane twin-stick zombie shooter with the Twitch streaming interactions, where you surviving hordes of zombies on dynamically changing arena and spectators may affect gameplay vi',
    'genres': ['Shooter', 'Indie', 'Arcade'],
    'platforms': [{'name': 'PlayStation 4', 'releaseDate': '2014-10-27'}, {
        'name': 'PC (Microsoft Windows)',
        'releaseDate': '2016-08-09'
    }, {'name': 'Xbox One', 'releaseDate': '2016-08-09'}, {
        'name': 'PlayStation Vita',
        'releaseDate': '2016-12-05'
    }],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2014-10-27',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 8616,
    'name': '&: Sora no Mukō de Saki Masuyō ni',
    'summary': null,
    'genres': ['Point-and-click'],
    'platforms': [{'name': 'PlayStation Vita', 'releaseDate': '2013-12-25'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2013-12-25',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 7724,
    'name': '.detuned',
    'summary': null,
    'genres': ['Indie'],
    'platforms': [{'name': 'PlayStation 3', 'releaseDate': '2009-09-16'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2009-09-16',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 24958,
    'name': '.flow',
    'summary': null,
    'genres': ['Adventure'],
    'platforms': [{'name': 'PC (Microsoft Windows)', 'releaseDate': '2009-02-14'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2009-02-14',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11811,
    'name': '.Hack//Frägment',
    'summary': 'The commercial success of the Project .Hack franchise led to the production of .hack//frägment-a remake of the series with online capabilities.\nThe game uses the same engine as the .hack series with a',
    'genres': ['Role-playing (RPG)', "Hack and slash/Beat 'em up"],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2005-11-22'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2005-11-22',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/zr6mya3uyt4w9tdsgqhb.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11987,
    'name': '.hack//G.U. Vol. 1: Rebirth',
    'summary': '.hack//G.U. simulates a massively multiplayer online role-playing game; players assume the role of a participant in a fictional game called The World. While in The World, the player controls the on-sc',
    'genres': ['Role-playing (RPG)'],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2006-05-17'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2006-05-17',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/v3khs6u3qizk8zpqgq5l.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11988,
    'name': '.hack//G.U. Vol. 2: Reminisce',
    'summary': '.hack//G.U. Vol. 2: Reminisce is the second entry in the .hack//G.U. series containing: Vol. 1: Rebirth, .hack//G.U. Vol. 2: Reminisce and .hack//G.U. Vol. 3: Redemption. As in the previous .hack game',
    'genres': ['Role-playing (RPG)'],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2006-09-27'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2006-09-27',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/awebqy0r5s959zowvz0s.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 12027,
    'name': '.hack//G.U. Vol. 3: Redemption',
    'summary': '.hack//G.U. Vol. 3: Redemption is the third entry in the .hack//G.U. series containing: Vol. 1: Rebirth, .hack//G.U. Vol. 2: Reminisce and .hack//G.U. Vol. 3: Redemption. As in the previous .hack game',
    'genres': ['Role-playing (RPG)'],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2007-01-17'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2007-01-17',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/puagwpeigrxwhablmqb2.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11807,
    'name': '.hack//Infection',
    'summary': '.Hack//Infection is the first of a series of four games, titled .hack//Infection, .hack//Mutation, .hack//Outbreak, and .hack//Quarantine, features a "game within a game"; a fictional massively multip',
    'genres': ['Role-playing (RPG)', "Hack and slash/Beat 'em up"],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2002-06-19'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2002-06-19',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/tvwarkyhlvlhbj8wqpuf.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11808,
    'name': '.Hack//Mutation',
    'summary': '.Hack//Mutation is the second of a series of four games, titled .hack//Infection, .hack//Mutation, .hack//Outbreak, and .hack//Quarantine, features a "game within a game"; a fictional massively multip',
    'genres': ['Role-playing (RPG)', "Hack and slash/Beat 'em up"],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2002-09-08'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2002-09-08',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/cyx8wlokoprorsgqweas.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11809,
    'name': '.Hack//Outbreak',
    'summary': '.Hack//Outbreak is the third of a series of four games, titled .hack//Infection, .hack//Mutation, .hack//Outbreak, and .hack//Quarantine, features a "game within a game"; a fictional massively multipl',
    'genres': ['Role-playing (RPG)', "Hack and slash/Beat 'em up"],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2002-12-11'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2002-12-11',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/jzwz2n9duxfhcdfmmigr.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 11810,
    'name': '.Hack//Quarantine',
    'summary': '.Hack//Quarantine is the fourth of a series of four games, titled .hack//Infection, .hack//Mutation, .hack//Outbreak, and .hack//Quarantine, features a "game within a game"; a fictional massively mult',
    'genres': ['Role-playing (RPG)', "Hack and slash/Beat 'em up"],
    'platforms': [{'name': 'PlayStation 2', 'releaseDate': '2003-04-09'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2003-04-09',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/i3ua51lxekfu5rx4jd32.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 9770,
    'name': '//N.P.P.D. RUSH//- The milk of Ultraviolet',
    'summary': null,
    'genres': ['Fighting', 'Shooter', 'Indie'],
    'platforms': [{'name': 'PC (Microsoft Windows)', 'releaseDate': '2014-02-12'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2014-02-12',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 22467,
    'name': '@ Home Mate',
    'summary': null,
    'genres': ['Simulator'],
    'platforms': [{'name': 'PC (Microsoft Windows)', 'releaseDate': '2009-05-28'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2009-05-28',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 8615,
    'name': '@field',
    'summary': null,
    'genres': ['Sport'],
    'platforms': [{'name': 'PlayStation Vita', 'releaseDate': '2012-03-28'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2012-03-28',
    'coverPictureUrl': 'http://res.cloudinary.com/dtbyr26w9/image/upload/v1476797451/default-cover-picture.png',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 7522,
    'name': '0 A.D.',
    'summary': '0 A.D. is a free, open-source, historical Real Time Strategy (RTS) game currently under development by a global group of volunteer game developers. As the leader of an ancient civilization, you must g',
    'genres': ['Real Time Strategy (RTS)'],
    'platforms': [],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': null,
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/rwhafb8nebwrc84edjd1.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 6172,
    'name': '0 Day Attack on Earth',
    'summary': 'Earth is under attack by massive creatures from outer space. With a huge arsenal of heavy-power artillery at your disposal, climb into your fighter jet and wage fierce battles against these gruesome a',
    'genres': ['Shooter'],
    'platforms': [{'name': 'Xbox 360', 'releaseDate': '2009-12-22'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2009-12-22',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/g11pywdl6xc5xtibcfvp.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 1649,
    'name': '007 Legends',
    'summary': '007 Legends features an original, overarching storyline tying together six classic Bond movies for an original James Bond experience, and equips players with state-of-the-art spy gadgets, an arsenal o',
    'genres': ['Shooter'],
    'platforms': [{'name': 'PC (Microsoft Windows)', 'releaseDate': '2012-11-01'}, {
        'name': 'Wii U',
        'releaseDate': '2012-12-06'
    }, {'name': 'Xbox 360', 'releaseDate': '2012-10-15'}, {
        'name': 'PlayStation 3',
        'releaseDate': '2012-10-15'
    }],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 10.0,
    'releaseDate': '2012-10-15',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/jcrogdw8eiiwgcw6xxpv.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 1642,
    'name': '007 Racing',
    'summary': "In 007 Racing you can get behind the wheel of James Bond's car.\n\nYou must complete missions which range from collecting an object and getting out alive, to much harder and more complicated things. You",
    'genres': ['Racing'],
    'platforms': [{'name': 'PlayStation', 'releaseDate': '2000-11-19'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2000-11-19',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/bgnqj0lgegurxduopbls.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 1643,
    'name': '007: Agent Under Fire',
    'summary': '007: Agent Under Fire is the first James Bond game to appear on the PlayStation 2, GameCube, and Xbox. The game casts the player as the legendary James Bond who must accomplish missions throughout dif',
    'genres': ['Shooter'],
    'platforms': [{'name': 'Xbox', 'releaseDate': '2002-03-25'}, {
        'name': 'Nintendo GameCube',
        'releaseDate': '2002-06-13'
    }, {'name': 'PlayStation 2', 'releaseDate': '2001-11-12'}],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 8.0,
    'releaseDate': '2001-11-12',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/e8psa7kavu2z9tchbjh8.jpg',
    'pictureUrls': null,
    'videoUrls': null
}, {
    'id': 1645,
    'name': '007: From Russia with Love',
    'summary': "From Russia with Love is a video game featuring Ian Fleming's secret agent, James Bond. The game is based on the 1957 novel and the 1963 film of the same name, albeit adding in new scenes to make the ",
    'genres': ['Shooter'],
    'platforms': [{'name': 'Xbox', 'releaseDate': '2005-10-31'}, {
        'name': 'Nintendo GameCube',
        'releaseDate': '2005-11-14'
    }, {'name': 'PlayStation Portable', 'releaseDate': '2006-04-02'}, {
        'name': 'PlayStation 2',
        'releaseDate': '2005-10-31'
    }],
    'publishers': null,
    'developers': null,
    'keywords': null,
    'avgScore': 0.0,
    'releaseDate': '2005-10-31',
    'coverPictureUrl': 'https://res.cloudinary.com/igdb/image/upload/t_cover_big_2x/zjc21kkx2mc7nybndum4.jpg',
    'pictureUrls': null,
    'videoUrls': null
}];

define(['powerUp', 'angular-mocks', 'restangular', 'PaginationService'], function () {

    // What you are testing
    describe('PaginationService', function () {

        // Always necessary
        beforeEach(module('powerUp'));

        // All the dependencies for AuthService
        var $httpBackend,   // Used to mock API calls
            $log,
            Restangular,
            PaginationService;

        var restangularEquality = function(a, b) {
            return a.id === b.id;
        };

        // Have angular inject everything
        beforeEach(inject(function (_$httpBackend_, _$log_, _Restangular_, _PaginationService_) {
            $httpBackend = _$httpBackend_;
            $log = _$log_;
            Restangular = _Restangular_;
            PaginationService = _PaginationService_;
        }));

        afterEach(function() {
            // Verify we made EXACTLY the number of network requests we expected - not more and not less
            $httpBackend.verifyNoOutstandingExpectation();
            $httpBackend.verifyNoOutstandingRequest();
        });

        describe('#initialize', function() {
           describe('On invalid calls', function () {
               it('Ignores without an object', function () {
                   expect(PaginationService.initialize()).toBeNull();
               });

               it('Ignores without a restangularized object', function () {
                   expect(PaginationService.initialize({})).toBeNull();
                   expect(PaginationService.initialize({restangularized: false})).toBeNull();
               });
           });

           describe('On valid calls', function () {
              it('Adds a pagination property', function () {
                  var obj = Restangular.all('games');
                  var paginator = PaginationService.initialize(obj);
                  expect(paginator.hasOwnProperty('pagination')).toBe(true);
              });

               it('Puts the proper pagination values', function () {
                   var obj = Restangular.all('games');
                   var pageNumber = 2, pageSize = 33;
                   var paginator = PaginationService.initialize(obj, undefined, pageNumber, pageSize);
                   expect(paginator.pagination).toEqual(getPaginationData(undefined, pageNumber, pageSize));
               });
           });
        });

        describe('#isInitialized', function () {
            it('Returns false for invalid calls', function () {
                expect(PaginationService.isInitialized()).toBe(false);
                expect(PaginationService.isInitialized(null)).toBe(false);
                expect(PaginationService.isInitialized({})).toBe(false);
                expect(PaginationService.isInitialized({isRestangularized: false})).toBe(false);
                expect(PaginationService.isInitialized({pagination: {}})).toBe(false);
            });

            it('Returns true for valid calls', function () {
                var paginator = PaginationService.initialize(Restangular.all('games'));
                expect(PaginationService.isInitialized(paginator)).toBe(true);
            });
        });

        describe('#setRequestParams', function () {
            it('Ignores invalid calls', function () {
                var invalidObj = {};
                PaginationService.setRequestParams(invalidObj, {garbage: true});
                expect(invalidObj).toEqual({});
            });

            it('Modifies the paginator adequately', function () {
                var paginator = PaginationService.initialize(Restangular.all('games'));
                var params = {sortDirection: 'asc'};
                PaginationService.setRequestParams(paginator, params);
                expect(paginator.pagination.params).toEqual(params);
            });
        });

        describe('#get', function () {
            it('Ignores invalid calls', function () {
                PaginationService.get({});
                // See afterEach(), no requests should've been fired
            });

            describe('On valid calls', function () {
                var paginator;

                beforeEach(function () {
                   var requestRegex = new RegExp(Restangular.configuration.baseUrl.concat('/games').concat('.*'));

                   paginator = PaginationService.initialize(Restangular.all('games'));
                   $httpBackend.expectGET(requestRegex).respond(mockSearchResponse);
               });

               it('Catches pagination headers', function () {
                   var params = {sortDirection: 'desc'};
                   PaginationService.setRequestParams(paginator, params);
                   expect(paginator.pagination.params).toEqual(params);
                   // For beforeEach not to fail
                   PaginationService.get(paginator);
                   $httpBackend.flush();
               });

                it('Calls the success function', function () {
                    var fun = jasmine.createSpy();  // Function that does nothing, watched
                    PaginationService.get(paginator, fun);
                    $httpBackend.flush();
                    expect(fun).toHaveBeenCalled();
                });

               it('Returns the correct data', function () {
                   var responseGames;

                   /*eslint-disable */
                   PaginationService.get(paginator, function (response) {
                        responseGames = response.data;
                   });
                   /*eslint-enable */
                   $httpBackend.flush();
                   // Expect to have received all games, albeit possibly in different order
                   expect(isIncluded(responseGames, games, restangularEquality)).toBe(true);
               });
            });
        });

        describe('Page methods', function () {
            var requestRegex;
            var paginator;
            var responseGames;
            var originalGames;

            beforeEach(function () {
                requestRegex = new RegExp(Restangular.configuration.baseUrl.concat('/games').concat('.*'));
                responseGames = null;
                originalGames = null;
                paginator = PaginationService.initialize(Restangular.all('games'), undefined, 2, 5);
                $httpBackend.expectGET(requestRegex).respond(mockSearchResponse);
            });

            it('#getPage returns the expected games', function () {
                // Get the 3rd page
                originalGames = games.slice(15, 20);
                PaginationService.getPage(paginator, 4, function (response) {
                    responseGames = response.data;
                });
                $httpBackend.flush();
                expect(isIncluded(responseGames, originalGames, restangularEquality)).toBe(true);
                expect(paginator.pagination.pageNumber).toEqual(4);
            });

            it('#getNextPage returns the expected games', function () {
                originalGames = games.slice(10, 15);
                PaginationService.getNextPage(paginator, function (response) {
                    responseGames = response.data;
                });
                $httpBackend.flush();
                expect(isIncluded(responseGames, originalGames, restangularEquality)).toBe(true);
                expect(paginator.pagination.pageNumber).toEqual(3);
            });

            it('#getPreviousPage returns the expected games', function () {
                originalGames = games.slice(0, 5);
                PaginationService.getPreviousPage(paginator, function (response) {
                    responseGames = response.data;
                });
                $httpBackend.flush();
                expect(isIncluded(responseGames, originalGames, restangularEquality)).toBe(true);
                expect(paginator.pagination.pageNumber).toEqual(1);
            });

            it('Numerous calls to #getPreviousPage stop at 0', function () {
                PaginationService.getPreviousPage(paginator);
                $httpBackend.flush();
                expect(paginator.pagination.pageNumber).toEqual(1);
                // Do it again; expect a second request
                $httpBackend.expectGET(requestRegex).respond(mockSearchResponse);
                PaginationService.getPreviousPage(paginator);
                $httpBackend.flush();
                expect(paginator.pagination.pageNumber).toEqual(1);
            });

            it('#getFirstPage returns the expected games', function () {
                originalGames = games.slice(0, 5);
                PaginationService.getFirstPage(paginator, function (response) {
                    responseGames = response.data;
                });
                $httpBackend.flush();
                expect(isIncluded(responseGames, originalGames, restangularEquality)).toBe(true);
                expect(paginator.pagination.pageNumber).toEqual(1);
            });

            /*
                Because of how we use expectGET (i.e. with regex), testing #getLastPage fails; the
                service performs 2 requests, both of which match the expectation, but only 1 is allowed.
                Since we can't find a reasonable solution for this, we aren't testing this function.
                FIXME and test #getLastPage
             */
            // it('#getLastPage returns the expected games', function () {
            //     originalGames = games.slice(20, 25);
            //     // Expect a second request to get the last page
            //     PaginationService.getLastPage(paginator, function (response) {
            //         responseGames = response.data;
            //     });
            //     $httpBackend.flush();
            //     expect(isIncluded(responseGames, originalGames, restangularEquality)).toBe(true);
            //     expect(paginator.pagination.pageNumber).toEqual(5);
            // });
        });

        describe('#hasMorePages', function () {
            describe('On invalid calls', function () {
                it('Ignores without an object', function () {
                    expect(PaginationService.hasMorePages()).toBeUndefined();
                });

                it('Ignores without a restangularized object', function () {
                    expect(PaginationService.hasMorePages({})).toBeUndefined();
                    expect(PaginationService.hasMorePages({restangularized: false})).toBeUndefined();
                });
            });

            describe('On valid calls', function () {
                var requestRegex;
                var paginator;

                beforeEach(function () {
                    requestRegex = new RegExp(Restangular.configuration.baseUrl.concat('/games').concat('.*'));
                    $httpBackend.expectGET(requestRegex).respond(mockSearchResponse);
                });

                it('Returns true when there are pages left', function () {
                    paginator = PaginationService.initialize(Restangular.all('games'), undefined, 1, 5);
                    PaginationService.get(paginator);
                    $httpBackend.flush();
                    expect(PaginationService.hasMorePages(paginator)).toBe(true);
                });

                it('Returns false when there are pages left', function () {
                    paginator = PaginationService.initialize(Restangular.all('games'), undefined, 1, games.length);
                    PaginationService.get(paginator);
                    $httpBackend.flush();
                    expect(PaginationService.hasMorePages(paginator)).toBe(false);
                });
            });
        });
    });

    function getPaginationData(subElement, pageNumber, pageSize, orderBy, sortDirection) {
        return {
            subElement: subElement,
            pageNumber: pageNumber,
            pageSize: pageSize,
            orderBy: orderBy,
            sortDirection: sortDirection
        };
    }

    /**
     * Mocks a backend game search, using the games variable as database.
     * NOTE: Query params are not provided until version 1.5.something, we use 1.3.x
     */
    function mockSearchResponse(method, url, queryData, queryHeaders/* , queryParams*/) {
        var queryParams = extractQueryParams(url);

        var params = Object.assign(// Defaults, overwritten by actual query params
            {
                pageNumber: 1,
                pageSize: 25,
                orderBy: 'name',
                sortDirection: 'asc'
            }, queryParams);
        // Manually convert certain params to int because we receive them as strings
        params.pageNumber = parseInt(params.pageNumber, 10);
        params.pageSize = parseInt(params.pageSize, 10);

        // Handle invalid requests
        if (params.pageNumber < 1 || params.pageNumber > Math.ceil(games.length / params.pageSize)) {
            return [400];
        } else if (['name', 'avgScore', 'releaseDate'].indexOf(params.orderBy) === -1) {
            return [400];
        } else if (['asc', 'desc'].indexOf(params.sortDirection) === -1) {
            return [400];
        }

        // Valid, build response
        var offset = (params.pageNumber - 1) * params.pageSize;
        var data = games.slice(offset, Math.min(offset + params.pageSize, games.length));
        // TODO: Support sorting

        var headers = mockSearchHeaders(data, params);

        return [200, data, headers];
    }

    /**
     * Mocks backend search response headers from a given search result (data)
     */
    function mockSearchHeaders(data, params) {
        var result = {
            'X-Total-Pages': Math.ceil(games.length / params.pageSize),
            'X-Amount-Of-Elements': data.length,
            'X-Overall-Amount-Of-Elements': games.length,
            'X-Page-Number': params.pageNumber,
            'X-Page-Size': params.pageSize
        };
        if (params.pageNumber > 1) {
            result['X-Prev-Page-Url'] = 'http://localhost:8080/api/games?orderBy=name&sortDirection=asc&pageSize=25&pageNumber=' + (params.pageNumber - 1) + '&name=&genre=&publisher=&developer=&keyword=&platform=';
        }
        if (params.pageNumber < result['X-Total-Pages']) {
            result['X-Next-Page-Url'] = 'http://localhost:8080/api/games?orderBy=name&sortDirection=asc&pageSize=25&pageNumber=' + (params.pageNumber + 1) + '&name=&genre=&publisher=&developer=&keyword=&platform=';
        }
        return result;
    }

    /**
     * Checks whether a provided array is included in another array.
     *
     * @param small         The included array
     * @param big           The array in which small may be included
     * @param equalityFn    (Optional) Function to test equality between elements of small and big. Defaults to ===
     * @return {boolean}    Whether small is included in big (i.e. if every element from small could be matched to one
     *                      element in big)
     */
    function isIncluded(small, big, equalityFn) {
        // Included if every element in small can be found in big
        return small.every(function(smallElement) {
            var index = big.findIndex(function(bigElement) {
                if (typeof equalityFn === 'function') {
                    return equalityFn(smallElement, bigElement);
                } else {
                    return smallElement === bigElement;
                }
            });
            return index !== -1;    // Not found, small is not included in big
        });
    }
});
